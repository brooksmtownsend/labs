<!DOCTYPE html>
<html lang="en" class="js csstransforms3d">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="generator" content="Hugo 0.55.5" />
    <meta name="description" content="">


    <link rel="icon" href="/labs/images/favicon.png" type="image/png">

    <title>Updating a NodeJS App :: Critical Stack Labs</title>

    
    <link href="/labs/css/nucleus.css?1558125502" rel="stylesheet">
    <link href="/labs/css/fontawesome-all.min.css?1558125502" rel="stylesheet">
    <link href="/labs/css/hybrid.css?1558125502" rel="stylesheet">
    <link href="/labs/css/featherlight.min.css?1558125502" rel="stylesheet">
    <link href="/labs/css/perfect-scrollbar.min.css?1558125502" rel="stylesheet">
    <link href="/labs/css/auto-complete.css?1558125502" rel="stylesheet">
    <link href="/labs/css/atom-one-dark-reasonable.css?1558125502" rel="stylesheet">
    <link href="/labs/css/theme.css?1558125502" rel="stylesheet">
    <link href="/labs/css/hugo-theme.css?1558125502" rel="stylesheet">
    
      <link href="/labs/css/theme-cs.css?1558125502" rel="stylesheet">
    

    <script src="/labs/js/jquery-3.3.1.min.js?1558125502"></script>

    <style type="text/css">
      :root #header + #content > #left > #rlblock_left{
          display:none !important;
      }
      
    </style>
    
  </head>
  <body class="" data-url="/labs/featurelabs/node/updating/">
    <nav id="sidebar" class="">



  <div id="header-wrapper">
    <div id="header">
      <a id="logo" href="https://criticalstack.github.io/labs/">
    <svg id="Layer_1" data-name="Layer 1"
    style="width:100%; height:100%;" viewBox="0 0 304 150" 
    xmlns="http://www.w3.org/2000/svg" ><defs><style>.cls-1{fill:#5178bc;}.cls-2,.cls-3{fill:#fff;}.cls-3{opacity:0.3;}.cls-4{fill:#a7a8a9;}</style></defs><title>Artboard 1</title><path class="cls-1" d="M179.53,82.74,146.07,69.46a6.47,6.47,0,0,0-4.78,0L107.83,82.74a6.47,6.47,0,0,0-4.09,6v40.48a6.48,6.48,0,0,0,4.09,6l33.46,13.28a6.47,6.47,0,0,0,4.78,0l33.46-13.28a6.48,6.48,0,0,0,4.09-6V88.76A6.47,6.47,0,0,0,179.53,82.74ZM172,108.19a2.15,2.15,0,0,1-1.36,2l-26.19,10.4a2.18,2.18,0,0,1-1.59,0l-26.2-10.4a2.15,2.15,0,0,1-1.36-2V93a2.16,2.16,0,0,1,1.36-2l26.2-10.39a2.09,2.09,0,0,1,1.59,0l18.08,7.17a.19.19,0,0,1,0,.35l-11.12,4.41a2.16,2.16,0,0,1-1.58,0l-5.38-2.14a2.18,2.18,0,0,0-1.59,0l-12.54,5a2.14,2.14,0,0,0-1.36,2v6.49a2.16,2.16,0,0,0,1.36,2l12.54,5a2.09,2.09,0,0,0,1.59,0l12.53-5a2.16,2.16,0,0,0,1.36-2v-2.1a2.14,2.14,0,0,1,1.35-2l12-4.76a.24.24,0,0,1,.32.22Z"/><path class="cls-2" d="M171.71,95l-12,4.76a2.14,2.14,0,0,0-1.35,2v2.1a2.16,2.16,0,0,1-1.36,2l-12.53,5a2.09,2.09,0,0,1-1.59,0l-12.54-5a2.16,2.16,0,0,1-1.36-2V97.33a2.14,2.14,0,0,1,1.36-2l12.54-5a2.18,2.18,0,0,1,1.59,0l5.38,2.14a2.16,2.16,0,0,0,1.58,0l11.12-4.41a.19.19,0,0,0,0-.35l-18.08-7.17a2.09,2.09,0,0,0-1.59,0L116.69,91a2.16,2.16,0,0,0-1.36,2v15.24a2.15,2.15,0,0,0,1.36,2l26.2,10.4a2.18,2.18,0,0,0,1.59,0l26.19-10.4a2.15,2.15,0,0,0,1.36-2v-13A.24.24,0,0,0,171.71,95Z"/><path class="cls-3" d="M170.68,122.06l-26.21,10.4a2.16,2.16,0,0,1-1.58,0l-26.21-10.4c-1.35-.51-1.35-.51-1.35,0v3a2.14,2.14,0,0,0,1.35,2l26.21,10.4a2.16,2.16,0,0,0,1.58,0l26.21-10.4a2.14,2.14,0,0,0,1.35-2v-3C172,121.52,172,121.53,170.68,122.06Z"/><path class="cls-3" d="M170.68,113.64,144.47,124a2.06,2.06,0,0,1-1.58,0l-26.21-10.4c-1.35-.5-1.35-.5-1.35,0v3a2.14,2.14,0,0,0,1.35,2L142.89,129a2.16,2.16,0,0,0,1.58,0l26.21-10.4a2.14,2.14,0,0,0,1.35-2v-3C172,113.11,172,113.12,170.68,113.64Z"/><path class="cls-4" d="M183.11,73.16A.14.14,0,0,1,183,73V70.26l-1.23,2.82s-.13.08-.19.08-.19,0-.21-.08l-1.25-2.82V73a.13.13,0,0,1-.14.13h-.34a.14.14,0,0,1-.15-.13V69.14a.14.14,0,0,1,.15-.14h.52a.16.16,0,0,1,.14.09l1.28,3,1.28-3A.14.14,0,0,1,183,69h.53a.14.14,0,0,1,.14.14V73a.13.13,0,0,1-.14.13Zm-6.05,0a.14.14,0,0,1-.15-.13V69.57h-1.14a.15.15,0,0,1-.15-.14v-.29a.15.15,0,0,1,.15-.14h2.93a.15.15,0,0,1,.15.14v.29a.15.15,0,0,1-.15.14h-1.13V73a.13.13,0,0,1-.14.13Z"/></svg>
</a>
<div style="color:#fff; font-size: medium;"><b>LABS</b></div>
    </div>
    
        <div class="searchbox">
    <label for="search-by"><i class="fas fa-search"></i></label>
    <input data-search-input id="search-by" type="search" placeholder="Search...">
    <span data-search-clear=""><i class="fas fa-times"></i></span>
</div>

<script type="text/javascript" src="/labs/js/lunr.min.js?1558125502"></script>
<script type="text/javascript" src="/labs/js/auto-complete.js?1558125502"></script>
<script type="text/javascript">
    
        var baseurl = "https:\/\/criticalstack.github.io\/labs\/";
    
</script>
<script type="text/javascript" src="/labs/js/search.js?1558125502"></script>

    
  </div>

    <div class="highlightable">
    <ul class="topics">

        
          
          


 
  
    
    <li data-nav-id="/labs/faqs/" title="FAQ" class="dd-item 
        
        
        
        ">
      <a href="/labs/faqs/">
          <i class='fas fa-question-circle'></i> FAQ
          
      </a>
      
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/labs/install/" title="Installation" class="dd-item 
        
        
        
        ">
      <a href="/labs/install/">
          <i class='fas fa-download'></i> Installation
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/labs/install/awsaccount/" title="AWS Account Setup" class="dd-item 
        
        
        
        ">
      <a href="/labs/install/awsaccount/">
          <i class='fas fa-user-circle'></i> AWS Account Setup
          
      </a>
      
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/labs/install/aws_basic_cluster/" title="AWS Basic Cluster" class="dd-item 
        
        
        
        ">
      <a href="/labs/install/aws_basic_cluster/">
          <i class='fas fa-server'></i> AWS Basic Cluster
          
      </a>
      
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
          


 
  
    
    <li data-nav-id="/labs/featurelabs/" title="Feature Labs" class="dd-item 
        parent
        
        
        ">
      <a href="/labs/featurelabs/">
          <i class='fas fa-star'></i> Feature Labs
          
      </a>
      
      
        <ul>
          
          
            
          
          
          
        
          
            
            


 
  
    
    <li data-nav-id="/labs/featurelabs/node/" title="NodeJS Labs" class="dd-item 
        parent
        
        
        ">
      <a href="/labs/featurelabs/node/">
          <i class='fab fa-node'></i> NodeJS Labs
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/labs/featurelabs/node/deploystateless/" title="Deploying a NodeJS App" class="dd-item ">
        <a href="/labs/featurelabs/node/deploystateless/">
        <i class='fab fa-node'></i> Deploying a NodeJS App
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/labs/featurelabs/node/updating/" title="Updating a NodeJS App" class="dd-item active">
        <a href="/labs/featurelabs/node/updating/">
        <i class='fab fa-node'></i> Updating a NodeJS App
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
            
            


 
  
    
    <li data-nav-id="/labs/featurelabs/go/" title="Go Labs" class="dd-item 
        
        
        
        ">
      <a href="/labs/featurelabs/go/">
          <i class='fas fa-flask'></i> Go Labs
          
      </a>
      
      
        <ul>
          
          
          
          
        
          
            
            


 
  
    
      <li data-nav-id="/labs/featurelabs/go/hello/" title="Deploying a Go App" class="dd-item ">
        <a href="/labs/featurelabs/go/hello/">
        <i class='fas fa-flask'></i> Deploying a Go App
        
        </a>
    </li>
     
  
 

            
          
            
            


 
  
    
      <li data-nav-id="/labs/featurelabs/go/hello_rest/" title="Deploying a Stateless RESTful Go App" class="dd-item ">
        <a href="/labs/featurelabs/go/hello_rest/">
        <i class='fas fa-flask'></i> Deploying a Stateless RESTful Go App
        
        </a>
    </li>
     
  
 

            
          
        
        </ul>
              
    </li>
  
 

            
          
        
        </ul>
              
    </li>
  
 

          
         
    </ul>

    
    

    
    <section id="footer">
      <p>Built with <a href="https://github.com/matcornic/hugo-theme-learn"><i class="fas fa-heart"></i></a> from <a href="http://getgrav.org">Grav</a> and <a href="http://gohugo.io/">Hugo</a></p>

    </section>
  </div>
</nav>





        <section id="body">
        <div id="overlay"></div>
        <div class="padding highlightable">
              
              <div>
                <div id="top-bar">
                
                
                <div id="breadcrumbs" itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb">
                    <span id="sidebar-toggle-span">
                        <a href="#" id="sidebar-toggle" data-sidebar-toggle="">
                          <i class="fas fa-bars"></i>
                        </a>
                    </span>
                  
                  <span id="toc-menu"><i class="fas fa-list-alt"></i></span>
                  
                  <span class="links">
                 
                 
                    
          
          
            
            
          
          
            
            
          
          
            
            
          
          
            <a href='/labs/'></a> > <a href='/labs/featurelabs/'>Feature Labs</a> > <a href='/labs/featurelabs/node/'>NodeJS Labs</a> > Updating a NodeJS App
          
         
          
         
          
         
          
        
                 
                  </span>
                </div>
                
                    <div class="progress">
    <div class="wrapper">
<nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#using-critical-stack-to-update-a-scalable-stateless-application">Using Critical Stack to update a scalable, stateless application</a>
<ul>
<li><a href="#getting-started">Getting Started</a></li>
<li><a href="#overview">Overview</a></li>
<li><a href="#steps">Steps</a></li>
<li><a href="#conclusion">Conclusion</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </div>
</div>

                
              </div>
            </div>
            
        <div id="head-tags">
        
        </div>
        
        <div id="body-inner">
          
            <h1>
              
              Updating a NodeJS App
            </h1>
          

        





<h2 id="using-critical-stack-to-update-a-scalable-stateless-application">Using Critical Stack to update a scalable, stateless application</h2>

<h3 id="getting-started">Getting Started</h3>

<p>Before starting on this lab, you will need to have completed the <a href="../deploystateless">Previous Node lab</a>.</p>

<h3 id="overview">Overview</h3>

<p>In the previous lab we created a simple NodeJS application,
packaged the application in a docker image,
pushed the docker image to a public docker image repository (Docker Hub),
pulled that image into a Critical Stack deployment as a container instance,
and accessed the application via a public URL.</p>

<p>In this next lab, we will create more instances of the container,
update the application to show bread crumbs of those instances,
push that update to Docker Hub,
and use the Critical Stack UI to instruct Kubernetes to roll out the update while we refresh the public URL. This will let us observe that a seamless rolling update is done with zero downtime.</p>

<h3 id="steps">Steps</h3>

<ol>
<li><p>Edit <strong>app/index.js</strong> (in your <strong>node-lab</strong> directory) and replace the source code with the following:</p>

<pre><code>// Load the http module to create an http server.
var http = require('http');
// Load the os module to access network interfaces.
var os = require('os');
// Load the crypto module to generate a random number.
var crypto = require(&quot;crypto&quot;);


// Get all interfaces by IP address
var interfaces = os.networkInterfaces();
var addresses = [];
for (var k in interfaces) {
    for (var k2 in interfaces[k]) {
        var address = interfaces[k][k2];
        if (address.family === 'IPv4' &amp;&amp; !address.internal) {
            addresses.push(address.address);
        }
    }
}

// Generate a random number
var random_number = crypto.randomBytes(16).toString(&quot;hex&quot;);

// Configure our HTTP server to respond with Hello World to all requests.
var server = http.createServer(function (request, response) {
response.writeHead(200, {&quot;Content-Type&quot;: &quot;text/plain&quot;});
response.end(&quot;Hello World from &quot; + addresses + &quot; (&quot; + random_number + &quot;)\n&quot;);
});

// Listen on port 3000
server.listen(3000, &quot;0.0.0.0&quot;);

// Put a friendly message on the terminal
console.log(&quot;Server IPs: &quot; + addresses);
console.log(&quot;Random number: &quot; + random_number);
console.log(&quot;Server running at http://0.0.0.0:3000/&quot;);
</code></pre></li>

<li><p>Increment the application version number in your <strong>package.json</strong> file and re-run <code>npm install</code> to update the <strong>package-lock.json</strong> file.</p>

<pre><code class="language-terminal">user@testhost node-lab$ cat package.json
{
&quot;name&quot;: &quot;hello-node&quot;,
&quot;version&quot;: &quot;0.0.2&quot;,
&quot;description&quot;: &quot;Say hello from Node&quot;,
&quot;main&quot;: &quot;app/index.js&quot;,
&quot;scripts&quot;: {
    &quot;test&quot;: &quot;echo \&quot;Error: no test specified\&quot; &amp;&amp; exit 1&quot;
},
&quot;author&quot;: &quot;&quot;,
&quot;license&quot;: &quot;ISC&quot;
}
user@testhost node-lab$ npm install
npm WARN hello-node@0.0.2 No repository field.

up to date in 0.632s
found 0 vulnerabilities
</code></pre>

<ol>
<li>Build your docker image again, but this time tag it as <code>&lt;your-username&gt;/hello-node:0.0.2</code> so we can uniquely identify the new image. After it&rsquo;s built, <em>push</em> it to Docker Hub so it can be updated in your Critical Stack cluster.</li>
</ol>

<pre><code class="language-terminal">user@testhost node-lab$ docker build -t &lt;your-username&gt;/hello-node:0.0.2 -f Dockerfile .
Sending build context to Docker daemon  4.288MB
Step 1/9 : FROM node:9
---&gt; 08a8c8089ab1
Step 2/9 : RUN mkdir /src
---&gt; Using cache
---&gt; 3530d1bbe38a
Step 3/9 : WORKDIR /src
---&gt; Using cache
---&gt; 4096063f6a2b
Step 4/9 : COPY ./package.json /src/package.json
---&gt; ad23e7eb360e
Step 5/9 : COPY ./package-lock.json /src/package-lock.json
---&gt; 46c675f287b6
Step 6/9 : RUN npm install --silent
---&gt; Running in d3144afb3a54
up to date in 0.076s
Removing intermediate container d3144afb3a54
---&gt; 56cbd547eb6d
Step 7/9 : COPY ./app /src/app
---&gt; 50b39bb7ea64
Step 8/9 : EXPOSE 3000
---&gt; Running in 0ab1df6c4e2c
Removing intermediate container 0ab1df6c4e2c
---&gt; 67b69d1d4337
Step 9/9 : CMD [&quot;node&quot;, &quot;app/index.js&quot;]
---&gt; Running in 7925bde282fc
Removing intermediate container 7925bde282fc
---&gt; be1e663ce0d2
Successfully built be1e663ce0d2
Successfully tagged &lt;your-username&gt;/hello-node:0.0.2
user@testhost node-lab$ docker push &lt;your-username&gt;/hello-node:0.0.2
The push refers to repository [docker.io/&lt;your-username&gt;/hello-node]
13108b60c999: Pushed
328a2707105e: Pushed
700b0faff5ac: Pushed
eb80df9a56cf: Pushed
df64ff0ed93f: Layer already exists
71521673e105: Layer already exists
7695686f75c0: Layer already exists
e492023cc4f9: Layer already exists
cbda574aa37a: Layer already exists
8451f9fe0016: Layer already exists
858cd8541f7e: Layer already exists
a42d312a03bb: Layer already exists
dd1eb1fd7e08: Layer already exists
0.0.2: digest: sha256:2e1002b635cd983e7f2458331079f7b131d8096fd5994287c6f4933438513367 size: 3041
</code></pre></li>

<li><p>Go to the Critical Stack UI under <em><strong>Deployment Listings</strong></em>, find the row <em>my-first-deployment</em>, click on the gear icon, and select <em><strong>Scale</strong></em>.  Move the slider for <em><strong>Number of podS</strong></em> to <em>2</em> and then click <em><strong>OK</strong></em>.</p>

<p><img src="../../../images/featurelabs/node/ScaleDeployment1.png" alt="Scale deployment" title="Scale deployment" />
<img src="../../../images/featurelabs/node/ScaleDeployment2.png" alt="Scale deployment" title="Scale deployment" /></p></li>

<li><p>The previous step declaratively set the desired state of our deployment&rsquo;s pods. Watch the deployment scale from 1 to 2:</p>

<p><img src="../../../images/featurelabs/node/RollingUpdate.png" alt="Rolling update" title="Rolling update" /></p></li>

<li><p>Click on the gear icon again, and select <em><strong>Edit</strong></em>.  On line 36, change the Docker image tag from <code>0.0.1</code> to <code>0.0.2</code>. For example: image: &lsquo;<code>docker.io/jabbottc1/hello-node:0.0.1</code>&rsquo; becomes image: &lsquo;<code>docker.io/jabbottc1/hello-node:0.0.2</code>&rsquo;.  Next click <em><strong>Save</strong></em> and then <em><strong>Exit</strong></em>.</p>

<p><img src="../../../images/featurelabs/node/UseApplicationv2.png" alt="Use application v2" title="Use application v2" /></p>

<p>Note that while we are editing the deployment, another way to scale the application is to directly update the yaml as shown below.</p>

<p><img src="../../../images/featurelabs/node/IncreaseReplicasAndUseApplicationv2.png" alt="Increase replicas and use application v2" title="Increase replicas and use application v2" /></p></li>

<li><p>Refresh your browser pointing to the public URL for your application and watch the update roll out.  Also notice the different output when traffic shifts from one pod to another.  Note: changing <em><strong>Idle timeout</strong></em> to 1 in the load balancer configuration will reduce the amount of time between switching from one pod to another (in the same section used to get the public facing URL in the previous lab).</p>

<p><img src="../../../images/featurelabs/node/ChangingLBTimeout.png" alt="Change LB timeout" title="Change LB timeout" /></p></li>

<li><p>If you want to go back to the previous application version for any reason, simply edit the deployment again and change the Docker image tag from <code>0.0.2</code> back to <code>0.0.1</code>.</p></li>
</ol>

<h3 id="conclusion">Conclusion</h3>

<p>You should now feel comfortable with the basics of pushing new docker images to a repository and pulling them into a Critical Stack deployment running multiple instances of your image.  This process is the basis for ongoing updates.</p>


<footer class=" footline" >
	
</footer>


        
        </div> 
        

      </div>

    <div id="navigation">
        
        
        
        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                        
                    
                    

                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
                        
            
            
                
                    
                        
                        
                    
                
                

                    
                    
                    

                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
                        
            
            
                
                    
                
                

                    
                    
                    

                    
            
        
                    
            
        
                    
            
        
                    
            
        
        
        


	 
	 
		
			<a class="nav nav-prev" href="/labs/featurelabs/node/deploystateless/" title="Deploying a NodeJS App"> <i class="fa fa-chevron-left"></i></a>
		
		
			<a class="nav nav-next" href="/labs/featurelabs/go/" title="Go Labs" style="margin-right: 0px;"><i class="fa fa-chevron-right"></i></a>
		
	
    </div>

    </section>
    
    <div style="left: -1000px; overflow: scroll; position: absolute; top: -1000px; border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;">
      <div style="border: none; box-sizing: content-box; height: 200px; margin: 0px; padding: 0px; width: 200px;"></div>
    </div>
    <script src="/labs/js/clipboard.min.js?1558125502"></script>
    <script src="/labs/js/perfect-scrollbar.min.js?1558125502"></script>
    <script src="/labs/js/perfect-scrollbar.jquery.min.js?1558125502"></script>
    <script src="/labs/js/jquery.sticky.js?1558125502"></script>
    <script src="/labs/js/featherlight.min.js?1558125502"></script>
    <script src="/labs/js/html5shiv-printshiv.min.js?1558125502"></script>
    <script src="/labs/js/highlight.pack.js?1558125502"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script src="/labs/js/modernizr.custom-3.6.0.js?1558125502"></script>
    <script src="/labs/js/learn.js?1558125502"></script>
    <script src="/labs/js/hugo-learn.js?1558125502"></script>

    <link href="/labs/mermaid/mermaid.css?1558125502" type="text/css" rel="stylesheet" />
    <script src="/labs/mermaid/mermaid.js?1558125502"></script>
    <script>
        mermaid.initialize({ startOnLoad: true });
    </script>
    

  </body>
</html>

